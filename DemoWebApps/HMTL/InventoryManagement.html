<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>在庫管理</title>
    <script src="/Scripts/jquery-3.3.1.min.js"></script>
</head>
<body>
    <div>
        <h2>在庫の更新</h2>
        <p>
            品名：
            <select id="productName">
                <option>選択してください</option>
            </select>
        </p>

        <p>在庫数：<input type="number" id="quantity" />個</p>
    </div>
    <div>
        <input type="submit" value="更新" id="updateButton">
    </div>
    <script>
        $(document).ready(function () {
            var stockList = [];

            // 在庫リストの取得
            $.ajax({
                url: "",
                type: "GET"
            }).done(function (responce) {
                stockList = responce;
                // 在庫リストのプルダウンを作成
                $.each(responce, function (index, value) {
                    $("#productName").append("<option value=" + value.productId + ">" + value.name + "</option>");
                });
            }).fail(function (error) {
                alert(JSON.stringify(error));
            });

            // 在庫の表示
            $("#productName").on("change", function () {
                var id = $("#productName").val();
                if (!id) {
                    return;
                }
                // 在庫リストからプルダウンで選択した商品のIDに一致する在庫を抽出
                var stock = $.grep(stockList, function (value) {
                    return id == value.productId;
                });

                // 在庫リストから選択した商品の在庫数を表示
                $("#quantity").text(stock[0].quantity);
            });

            // 更新ボタン押下時
            $("#updateButton").on("click", function () {
                $("#productName").empty();
                $("#productName").append("<option>選択してください</option>");

                var data = {
                    productId: $("#productName").val(),
                    quantity: $("#quantity").val()
                };
                // 在庫の更新
                $.ajax({
                    url: "",
                    type: "PUT",
                    data: data,
                    dataType: "json"
                }).done(function (responce) {
                    alert("更新しました");
                }).fail(function (error) {
                    alert(JSON.stringify(error));
                });
                // 在庫リストの再取得
                $.ajax({
                    url: "",
                    type: "GET"
                }).done(function (responce) {
                    stockList = responce;
                    // 在庫リストを初期化
                    $("#productName").empty();
                    $("#productName").append("<option>選択してください</option>");

                    // 在庫リスト再取得
                    $.each(responce, function (index, value) {
                        $("#productName").append("<option value=" + value.productId + ">" + value.name + "</option>");
                    });
                }).fail(function (error) {
                    alert(JSON.stringify(error));
                });
            });
        });
    </script>
</body>
</html>